{% extends "site_base.html" %}

{% load i18n %}
{% load ifsetting_tag %}

{% load participation_tags %}

{% block head_title %}Idea #{{ meetingnote.id }}{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&amp;sensor=false&amp;language=en"></script>
<script src="{{ STATIC_URL }}js/infobubble-compiled.js"type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/vote.js"type="text/javascript"></script>
<link rel="stylesheet" href="{{ STATIC_URL }}css/maps.css" type="text/css" media="all" charset="utf-8" />
{% endblock %}

{% block body_class %}{% endblock %}

{% block body %}
<div class="grid_12"><h2>Meeting Note #{{ meetingnote.id }}</h2></div>
<div class="grid_7">
	{% if meetingnote.meeting_date %}<h5>For meeting on {{ meetingnote.meeting_date }}</h3>{% endif %}
	{{ meetingnote.desc_as_html }}
	{% if meetingnote.note_file or meetingnote.note_url %}<h5>Downloads:</h5>
	<ul>
		{% if meetingnote.note_file %}<li><a href="{{ meetingnote.note_file.url }}">{{ meetingnote.note_file.name|slice:"13:" }}</a></li>{% endif %}
		{% if meetingnote.note_url %}<li><a href="{{ meetingnote.note_url }}">{{ meetingnote.note_url }}</a></li>{% endif %}
	</ul>{% endif %}
	<div class="meta">Posted by <span class="author">{% firstof meetingnote.author.username meetingnote.author.first_name %}</span> on <span class="timestamp">{{ meetingnote.last_modified|date:"F dS Y" }}</span></div>
</div>

<div class="grid_5">
	{% if meetingnote.geometry or meetingnote.station %}<div id="idea_map">map</div>{% endif %}
	{% if meetingnote.station or meetingnote.theme %}<h5>This Meeting Note relates to</h5>{% endif %}
	{% if meetingnote.station %}<div>Station Area: <a href="{{ idea.station.get_absolute_url }}">{{ meetingnote.station.name }}</a></div>{% endif %}
	{% if meetingnote.theme %}<div>Theme: <a href="{{ idea.theme.get_absolute_url }}">{{ meetingnote.theme.title }}</a></div>{% endif %}
</div>
{% endblock %}

{% block body_onload %}{% if meetingnote.geometry or meetingnote.station %}initialize(){% endif %}{% endblock %}

{% block extra_body %}
{% if meetingnote.geometry or meetingnote.station %}
<script src="{{ STATIC_URL }}js/map.js" type="text/javascript"></script>
<script type="text/javascript">
		
	function initialize() {
		
		// basemap
		greenline.createBasemap('idea_map');
		
		var shadow = new google.maps.MarkerImage('{{ STATIC_URL }}img/isicons/shadow.png',
			new google.maps.Size(51,37),
			new google.maps.Point(0,0),
			new google.maps.Point(16,37)
		);
		
		{% if meetingnote.geometry %}
		var idea_icon = new google.maps.MarkerImage('{{ STATIC_URL }}img/isicons/text.png',
			new google.maps.Size(32,37),
			new google.maps.Point(0,0),
			new google.maps.Point(16,37)
		);
		var meetingnote_ll = new google.maps.LatLng({{ meetingnote.geometry.y }},{{ meetingnote.geometry.x }});
		var meetingnote = new google.maps.Marker({
			position: meetingnote_ll, 
			map: greenline.map,
			title: "Meeting Note Location",
			shadow: shadow,
			icon: idea_icon
		});
		{% endif %}
		
		{% if meetingnote.station %}
		// station icon
		var s_icon = new google.maps.MarkerImage('{{ STATIC_URL }}img/isicons/train.png',
			new google.maps.Size(32,37),
			new google.maps.Point(0,0),
			new google.maps.Point(16,37)
		);
		var s_{{ meetingnote.station.id }}_ll = new google.maps.LatLng({{ meetingnote.station.geometry.y }},{{ meetingnote.station.geometry.x }});
		var s_{{ meetingnote.station.id }} = new google.maps.Marker({
			position: s_{{ meetingnote.station.id }}_ll, 
			map: greenline.map,
			title:"{{ idea.station.name }}",
			shadow: shadow,
			icon: s_icon
		});
		var s_{{ meetingnote.station.id }}_area = new google.maps.Circle({
			map: greenline.map,
			fillColor: '#4F7B41',
			strokeColor: '#FFFFFF',
			fillOpacity: .3,
			strokeWeight: .6,
			radius: 804.67 // 804.67m = 0.5mi
		});
		s_{{ meetingnote.station.id }}_area.bindTo('center', s_{{ meetingnote.station.id }}, 'position');
		{% endif %}
		
		{% for line in lines %}		
		var l_{{ line.id }} = new google.maps.Polyline({
			path: google.maps.geometry.encoding.decodePath("{{ line.encoded.points|fixbackslash }}"),
			levels: greenline.decodeLevels("{{ line.encoded.levels }}"),
			strokeColor: '#4F7B41',
			strokeOpacity: 0.9,
			strokeWeight: 6,
			zoomFactor: {{ line.encoded.zoomFactor }}, 
			numLevels: {{ line.encoded.numLevels }},
			map: greenline.map
		});	
		{% endfor %}
		
		// zoom and center
		greenline.map.setOptions({
			zoom: 15,
			center: {% if meetingnote.geometry %}meetingnote_ll{% else %}s_{{ meetingnote.station.id }}_ll{% endif %}
		});
		
	}
</script>
{% endif %}
{% endblock %}
