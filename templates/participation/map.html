{% extends "site_base.html" %}

{% load i18n %}
{% load ifsetting_tag %}

{% load participation_tags %}

{% block head_title %}Explore our map{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&amp;sensor=false&amp;language=en"></script>
<script src="{{ STATIC_URL }}js/infobubble-compiled.js"type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/map.js" type="text/javascript"></script>
<link rel="stylesheet" href="{{ STATIC_URL }}css/maps.css" type="text/css" media="all" charset="utf-8" />
{% endblock %}

{% block body_class %}{% endblock %}

{% block body %}
<div class="grid_12"><h2>Explore our map</h2></div>
<div class="grid_12">
	<p>Filter items on map by:
	<select class="map-filter" id="select-station">
		<option value="" selected="selected">-- Related Station --</option>
		{% for station in stations %}<option value="{{ station.id }}">{{ station.name }}</option>{% endfor %}
	</select>
	<select class="map-filter" id="select-theme">
		<option value="" selected="selected">-- Related Theme --</option>
		{% for theme in themes %}<option value="{{ theme.id }}">{{ theme.title }}</option>{% endfor %}
	</select>
	<select class="map-filter" id="select-itemtype">
		<option value="" selected="selected">-- Type --</option>
		{% for k, v in itemtypes %}<option value="{{ k }}">{{ v }}</option>{% endfor %}
	</select></p>
</div>
<div class="grid_12">	
	<div id="explore_map">map</div>
</div>


{% endblock %}

{% block body_onload %}initialize(){% endblock %}

{% block extra_body %}
<script type="text/javascript">
		
	function initialize() {
		
		// media url
		greenline.static_url = '{{ STATIC_URL }}';
		
		// basemap
		greenline.createBasemap('explore_map');
		
		// zoom and center
		greenline.map.setOptions({
			zoom: 13,
			center: new google.maps.LatLng(42.397, -71.11)
		});
		
		// add station markers
		{% for station in stations %}
		greenline.createStationMarker({
			'title': '{{ station.name }}',
			'lat': {{ station.geometry.y }},
			'lon': {{ station.geometry.x }},
			'desc': '{{ station.desc|truncatewords:30 }}',
			'url': '{{ station.get_absolute_url }}'
		});
		{% endfor %}
		// add greenline
		{% for line in lines %}
		greenline.createGreenline({
			'points': '{{ line.encoded.points|fixbackslash }}',
			'levels': '{{ line.encoded.levels }}',
			'zoomFactor': {{ line.encoded.zoomFactor }},
			'numLevels': {{ line.encoded.numLevels }}
		})
		{% endfor %}
		
		// add drag and zoom event listeners to map
		google.maps.event.addListener(greenline.map, 'dragend', function() {
			greenline.explore.loadItems();
		});
		google.maps.event.addListener(greenline.map, 'zoom_changed', function() {
			greenline.explore.loadItems();
		});
		// initialize explore items
		google.maps.event.addListenerOnce(greenline.map, 'idle', function(){
			// triggered only the first time the map is loaded
			greenline.explore.loadItems();
		});
		
		// map filter
		$(".map-filter").change(function() {
			greenline.explore.loadItems();
		});
	}

</script>
<script src="{{ STATIC_URL }}js/comment.js" type="text/javascript"></script>
{% endblock %}
